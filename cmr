<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cobblemon Lucky Wheel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #eee;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #0f1419;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid #1e2936;
        }

        .header {
            background: linear-gradient(135deg, #1e2936 0%, #2d3748 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #3d5a80;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            padding: 30px;
        }

        .wheel-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }

        .wheel-type-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .wheel-type-btn {
            flex: 1;
            padding: 15px 30px;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #1a1f2e;
            color: #98c1d9;
        }

        .wheel-type-btn.active {
            background: linear-gradient(135deg, #3d5a80 0%, #5a7a9a 100%);
            color: white;
            border-color: #5a7a9a;
            box-shadow: 0 5px 15px rgba(61, 90, 128, 0.4);
        }

        .roulette-container {
            background: #1a1f2e;
            border: 2px solid #3d5a80;
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .roulette-wrapper {
            position: relative;
            width: 100%;
            height: 220px;
            overflow: hidden;
            border: 3px solid #3d5a80;
            border-radius: 10px;
            background: #0f1419;
        }

        .roulette-selector {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #e63946 0%, #ff006e 100%);
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 20px rgba(230, 57, 70, 0.8);
        }

        .roulette-selector::before {
            content: '‚ñº';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: #e63946;
            font-size: 24px;
            text-shadow: 0 0 10px rgba(230, 57, 70, 0.8);
        }

        .roulette-track {
            display: flex;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            height: 100%;
            align-items: center;
            position: relative;
        }

        .roulette-item {
            flex: 0 0 120px;
            height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1e2936;
            border: 2px solid #3d5a80;
            border-radius: 8px;
            margin: 0 5px;
            padding: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .roulette-item.shiny {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            border-color: #ffd60a;
            box-shadow: 0 0 20px rgba(255, 214, 10, 0.5);
        }

        .roulette-item.netherstar {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border-color: #4cc9f0;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.5);
        }

        .roulette-item img {
            width: 64px;
            height: 64px;
            image-rendering: pixelated;
            margin-bottom: 8px;
        }

        .roulette-item-name {
            font-size: 0.9em;
            font-weight: 600;
            color: #98c1d9;
            text-align: center;
            word-wrap: break-word;
            max-width: 100%;
        }

        .roulette-item.shiny .roulette-item-name {
            color: #000;
            text-shadow: 0 0 5px rgba(255, 214, 10, 0.8);
        }

        .roulette-item.netherstar .roulette-item-name {
            color: white;
            text-shadow: 0 0 5px rgba(76, 201, 240, 0.8);
        }

        .shiny-badge {
            font-size: 0.7em;
            color: #000;
            font-weight: 700;
            background: #ffd60a;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .item-count {
            font-size: 0.8em;
            color: #98c1d9;
            margin-top: 4px;
        }

        .spin-button {
            padding: 20px 50px;
            font-size: 1.3em;
            font-weight: 600;
            background: linear-gradient(135deg, #e63946 0%, #ff006e 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(230, 57, 70, 0.4);
            align-self: center;
            margin-top: 10px;
        }

        .spin-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(230, 57, 70, 0.6);
        }

        .spin-button:disabled {
            background: #2d3748;
            cursor: not-allowed;
            box-shadow: none;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .token-display {
            background: linear-gradient(135deg, #2d3748 0%, #3d5a80 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            border: 1px solid #3d5a80;
        }

        .token-display h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .token-count {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
            color: #98c1d9;
        }

        .player-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-size: 1em;
            margin-top: 10px;
            background: #1a1f2e;
            color: #98c1d9;
        }

        .refresh-button {
            width: 100%;
            padding: 12px;
            background: #1a1f2e;
            color: #98c1d9;
            border: 2px solid #3d5a80;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .refresh-button:hover {
            background: #3d5a80;
            color: white;
        }

        .pokemon-list {
            background: #1a1f2e;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #3d5a80;
        }

        .pokemon-list h3 {
            margin-bottom: 15px;
            color: #98c1d9;
            font-size: 1.3em;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .pokemon-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #0f1419;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.2s;
            border: 1px solid #2d3748;
            color: #98c1d9;
        }

        .pokemon-item:hover {
            transform: translateX(5px);
            border-color: #3d5a80;
        }

        .pokemon-sprite {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
        }

        .shiny-info {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            color: #000;
            box-shadow: 0 0 20px rgba(255, 214, 10, 0.3);
        }

        .result-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1a1f2e;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            z-index: 1000;
            text-align: center;
            min-width: 400px;
            border: 2px solid #3d5a80;
            max-width: 500px;
            width: 90%;
        }

        .result-popup.show {
            display: block;
            animation: popupAppear 0.5s ease;
        }

        .result-popup.shiny {
            background: linear-gradient(135deg, #ffd60a 0%, #ffb703 100%);
            border-color: #ffd60a;
        }

        .result-popup.netherstar {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            border-color: #4cc9f0;
        }

        @keyframes popupAppear {
            from {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .result-popup h2 {
            color: #98c1d9;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .result-popup.shiny h2,
        .result-popup.netherstar h2 {
            color: white;
        }

        .result-pokemon {
            margin: 20px 0;
        }

        .result-pokemon img {
            width: 120px;
            height: 120px;
            image-rendering: pixelated;
        }

        .result-pokemon-name {
            font-size: 1.5em;
            font-weight: 600;
            margin-top: 10px;
            color: #98c1d9;
        }

        .result-popup.shiny .result-pokemon-name,
        .result-popup.netherstar .result-pokemon-name {
            color: white;
        }

        .result-shiny-badge {
            display: inline-block;
            background: #000;
            color: #ffd60a;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            animation: shimmer 2s infinite;
        }

        .result-netherstar-badge {
            display: inline-block;
            background: white;
            color: #4361ee;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            margin-top: 10px;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .discord-notice {
            background: linear-gradient(135deg, #e63946 0%, #b91d43 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 0.9em;
            font-weight: 600;
            border: 2px solid #ff6b6b;
            box-shadow: 0 0 15px rgba(230, 57, 70, 0.3);
        }

        .close-popup {
            margin-top: 20px;
            padding: 12px 30px;
            background: linear-gradient(135deg, #3d5a80 0%, #5a7a9a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 600;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 999;
        }

        .overlay.show {
            display: block;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .pokemon-grid {
                grid-template-columns: 1fr;
            }
            
            .roulette-item {
                flex: 0 0 100px;
                height: 140px;
            }
            
            .roulette-item img {
                width: 48px;
                height: 48px;
            }
            
            .wheel-type-selector {
                flex-direction: column;
            }
            
            .result-popup {
                min-width: 300px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cobblemon Lucky Wheel</h1>
            <p>Trade a Masterball for a Legendary Token and spin!</p>
        </div>

        <div class="main-content">
            <div class="wheel-section">
                <div class="wheel-type-selector">
                    <button class="wheel-type-btn" onclick="switchWheel('daily')">Daily Spin</button>
                    <button class="wheel-type-btn active" onclick="switchWheel('normal')">Normal Legendaries</button>
                    <button class="wheel-type-btn" onclick="switchWheel('event')">Event Legendaries</button>
                </div>

                <div class="shiny-info" id="shinyInfo">‚ú® 1% chance for SHINY! ‚ú®</div>

                <div class="roulette-container">
                    <div class="roulette-wrapper">
                        <div class="roulette-selector"></div>
                        <div class="roulette-track" id="rouletteTrack"></div>
                    </div>
                </div>

                <button class="spin-button" id="spinButton" onclick="spin()">Spin the Wheel!</button>
            </div>

            <div class="sidebar">
                <div class="token-display">
                    <h3>Your Legendary Tokens</h3>
                    <select class="player-select" id="playerSelect" onchange="updateTokenDisplay()">
                        <option value="">Select Player...</option>
                    </select>
                    <div class="token-count" id="normalTokenCount">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Normal Tokens</div>
                    <div class="token-count" id="eventTokenCount" style="font-size: 2em; margin-top: 15px;">-</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Event Tokens</div>
                    <button class="refresh-button" onclick="loadTokenData()">üîÑ Refresh Tokens</button>
                </div>

                <div class="pokemon-list">
                    <h3 id="listTitle">Available Normal Legendaries</h3>
                    <div class="pokemon-grid" id="pokemonList"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="result-popup" id="resultPopup">
        <h2 id="resultTitle">Congratulations! üéâ</h2>
        <div class="discord-notice">
            ‚ö†Ô∏è IMPORTANT: Send a screenshot of this win to the Discord to claim your prize!
        </div>
        <div class="result-pokemon">
            <img id="resultSprite" src="" alt="Prize">
            <div class="result-pokemon-name" id="resultName"></div>
            <div id="shinyBadge" style="display: none;" class="result-shiny-badge">‚ú® SHINY ‚ú®</div>
            <div id="netherstarBadge" style="display: none;" class="result-netherstar-badge">üåü NETHER STAR üåü</div>
        </div>
        <button class="close-popup" onclick="closePopup()">Close</button>
    </div>

    <script>
        // Daily Spin Minecraft Items
        const dailyItems = [
            { name: 'Nether Star', id: 'nether_star', count: 1, type: 'netherstar', rarity: 'legendary' },
            { name: 'Diamond', id: 'diamond', count: 10, type: 'rare' },
            { name: 'Netherite Scrap', id: 'netherite_scrap', count: 3, type: 'rare' },
            { name: 'Iron Ingot', id: 'iron_ingot', count: 32, type: 'common' },
            { name: 'Gold Ingot', id: 'gold_ingot', count: 32, type: 'common' },
            { name: 'Emerald', id: 'emerald', count: 16, type: 'common' },
            { name: 'Lapis Lazuli', id: 'lapis_lazuli', count: 32, type: 'common' },
            { name: 'Redstone', id: 'redstone', count: 32, type: 'common' },
            { name: 'Coal', id: 'coal', count: 64, type: 'common' },
            { name: 'Experience Bottle', id: 'experience_bottle', count: 16, type: 'common' }
        ];

        // Pokemon lists
        const normalLegendaries = [
            { name: 'Zapdos', id: 145 },
            { name: 'Moltres', id: 146 },
            { name: 'Articuno', id: 144 },
            { name: 'Regirock', id: 377 },
            { name: 'Registeel', id: 379 },
            { name: 'Regice', id: 378 },
            { name: 'Regigigas', id: 486 },
            { name: 'Regieleki', id: 894 },
            { name: 'Regidrago', id: 895 },
            { name: 'Zarude', id: 893 }
        ];

        const eventLegendaries = [
            { name: 'Mew', id: 151 },
            { name: 'Mewtwo', id: 150 },
            { name: 'Lugia', id: 249 },
            { name: 'Ho-Oh', id: 250 },
            { name: 'Rayquaza', id: 384 },
            { name: 'Xerneas', id: 716 },
            { name: 'Latias', id: 380 },
            { name: 'Latios', id: 381 }
        ];

        let currentWheel = 'normal';
        let spinning = false;
        let tokenData = {};
        let selectedPlayer = '';
        const SHINY_CHANCE = 0.01;
        let rouletteItems = [];

        // Get Minecraft item sprite
        function getMinecraftSprite(id) {
            return `https://minecraftitemids.com/item/64/${id}.png`;
        }

        // Get Pokemon sprite
        function getSprite(id, shiny = false) {
            if (shiny) {
                return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`;
            }
            return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
        }

        // Load spins history from localStorage
        function loadSpinsHistory() {
            const history = localStorage.getItem('wheel_spins_history');
            return history ? JSON.parse(history) : {};
        }

        // Save spins history to localStorage
        function saveSpinsHistory(history) {
            localStorage.setItem('wheel_spins_history', JSON.stringify(history));
        }

        // Get remaining spins for player
        function getRemainingSpins(player, tokenType) {
            const history = loadSpinsHistory();
            const playerKey = player + (tokenType === 'event' ? '_event' : '');
            const usedSpins = history[playerKey] || 0;
            const availableTokens = tokenData[playerKey] || 0;
            
            return Math.max(0, availableTokens - usedSpins);
        }

        // Check if daily spin is available
        function canSpinDaily(player) {
            const history = loadSpinsHistory();
            const lastDailySpin = history[player + '_daily_timestamp'];
            
            if (!lastDailySpin) return true;
            
            const lastSpinDate = new Date(lastDailySpin);
            const now = new Date();
            
            // Check if 24 hours have passed
            const hoursSinceLastSpin = (now - lastSpinDate) / (1000 * 60 * 60);
            return hoursSinceLastSpin >= 24;
        }

        function createRoulette() {
            const track = document.getElementById('rouletteTrack');
            track.innerHTML = '';
            rouletteItems = [];
            
            let items;
            if (currentWheel === 'daily') {
                items = dailyItems;
            } else if (currentWheel === 'normal') {
                items = normalLegendaries;
            } else {
                items = eventLegendaries;
            }
            
            // Create enough items for a smooth spin
            for (let i = 0; i < 60; i++) {
                const item = items[Math.floor(Math.random() * items.length)];
                
                if (currentWheel === 'daily') {
                    const isNetherstar = item.type === 'netherstar';
                    rouletteItems.push({
                        ...item,
                        isShiny: false,
                        type: isNetherstar ? 'netherstar' : 'normal'
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'roulette-item' + (isNetherstar ? ' netherstar' : '');
                    div.innerHTML = `
                        <img src="${getMinecraftSprite(item.id)}" alt="${item.name}">
                        <div class="roulette-item-name">${item.name}</div>
                        <div class="item-count">${item.count}x</div>
                    `;
                    track.appendChild(div);
                } else {
                    const isShiny = Math.random() < 0.05; // 5% shiny in preview
                    rouletteItems.push({
                        pokemon: item,
                        isShiny: isShiny
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'roulette-item' + (isShiny ? ' shiny' : '');
                    div.innerHTML = `
                        <img src="${getSprite(item.id, isShiny)}" alt="${item.name}">
                        <div class="roulette-item-name">${item.name}</div>
                        ${isShiny ? '<div class="shiny-badge">SHINY</div>' : ''}
                    `;
                    track.appendChild(div);
                }
            }
            
            // Reset track position
            track.style.transform = 'translateX(0)';
        }

        function updatePokemonList() {
            const list = document.getElementById('pokemonList');
            const title = document.getElementById('listTitle');
            const shinyInfo = document.getElementById('shinyInfo');
            
            if (currentWheel === 'daily') {
                title.textContent = 'Daily Spin Rewards';
                shinyInfo.style.display = 'none';
                list.innerHTML = '';
                
                dailyItems.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'pokemon-item';
                    listItem.innerHTML = `
                        <img class="pokemon-sprite" src="${getMinecraftSprite(item.id)}" alt="${item.name}">
                        <span>${item.name} (${item.count}x)</span>
                    `;
                    list.appendChild(listItem);
                });
            } else {
                const legendaries = currentWheel === 'normal' ? normalLegendaries : eventLegendaries;
                title.textContent = currentWheel === 'normal' ? 'Available Normal Legendaries' : 'Available Event Legendaries';
                shinyInfo.style.display = 'block';
                list.innerHTML = '';
                
                legendaries.forEach(pokemon => {
                    const item = document.createElement('div');
                    item.className = 'pokemon-item';
                    item.innerHTML = `
                        <img class="pokemon-sprite" src="${getSprite(pokemon.id)}" alt="${pokemon.name}">
                        <span>${pokemon.name}</span>
                    `;
                    list.appendChild(item);
                });
            }
        }

        function switchWheel(type) {
            if (spinning) return;
            
            currentWheel = type;
            
            document.querySelectorAll('.wheel-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const buttons = document.querySelectorAll('.wheel-type-btn');
            if (type === 'daily') {
                buttons[0].classList.add('active');
            } else if (type === 'normal') {
                buttons[1].classList.add('active');
            } else {
                buttons[2].classList.add('active');
            }
            
            createRoulette();
            updatePokemonList();
            updateTokenDisplay();
        }

        async function loadTokenData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/freecrime/cml/refs/heads/main/coins');
                const text = await response.text();
                
                const lines = text.trim().split('\n');
                tokenData = {};
                
                lines.forEach(line => {
                    const match1 = line.match(/(\w+)\s*=\s*(\d+)/);
                    const match2 = line.match(/(\w+):\s*(\d+)/);
                    
                    if (match1) {
                        tokenData[match1[1]] = parseInt(match1[2]);
                    } else if (match2) {
                        tokenData[match2[1]] = parseInt(match2[2]);
                    }
                });
                
                const select = document.getElementById('playerSelect');
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select Player...</option>';
                
                const uniquePlayers = new Set();
                
                Object.keys(tokenData).forEach(key => {
                    let player = key;
                    
                    if (key.endsWith('_event')) {
                        player = key.replace('_event', '');
                    } else if (key.endsWith('_normal')) {
                        player = key.replace('_normal', '');
                    }
                    
                    uniquePlayers.add(player);
                });
                
                Array.from(uniquePlayers).sort().forEach(player => {
                    const option = document.createElement('option');
                    option.value = player;
                    option.textContent = player;
                    select.appendChild(option);
                });
                
                if (currentValue && uniquePlayers.has(currentValue)) {
                    select.value = currentValue;
                }
                
                updateTokenDisplay();
            } catch (error) {
                console.error('Error loading token data:', error);
                alert('Failed to load token data. Please try again.');
            }
        }

        function updateTokenDisplay() {
            const player = document.getElementById('playerSelect').value;
            const normalCount = document.getElementById('normalTokenCount');
            const eventCount = document.getElementById('eventTokenCount');
            
            if (player && tokenData) {
                selectedPlayer = player;
                
                const normalTokens = tokenData[player] || tokenData[player + '_normal'] || 0;
                const eventTokens = tokenData[player + '_event'] || 0;
                
                const remainingNormal = getRemainingSpins(player, 'normal');
                const remainingEvent = getRemainingSpins(player, 'event');
                
                normalCount.textContent = `${remainingNormal} / ${normalTokens}`;
                eventCount.textContent = `${remainingEvent} / ${eventTokens}`;
                
                if (remainingNormal <= 0) {
                    normalCount.style.color = '#e63946';
                } else {
                    normalCount.style.color = '#98c1d9';
                }
                
                if (remainingEvent <= 0) {
                    eventCount.style.color = '#e63946';
                } else {
                    eventCount.style.color = '#98c1d9';
                }
                
            } else {
                normalCount.textContent = '-';
                eventCount.textContent = '-';
                normalCount.style.color = '#98c1d9';
                eventCount.style.color = '#98c1d9';
                selectedPlayer = '';
            }
        }

        function spin() {
            if (spinning) return;
            
            if (!selectedPlayer) {
                alert('Please select a player first!');
                return;
            }
            
            // Check for daily spin
            if (currentWheel === 'daily') {
                if (!canSpinDaily(selectedPlayer)) {
                    const history = loadSpinsHistory();
                    const lastSpin = new Date(history[selectedPlayer + '_daily_timestamp']);
                    const nextSpin = new Date(lastSpin.getTime() + (24 * 60 * 60 * 1000));
                    const hoursLeft = Math.ceil((nextSpin - new Date()) / (1000 * 60 * 60));
                    alert(`Daily spin not available yet! Come back in ${hoursLeft} hours.`);
                    return;
                }
            } else {
                const tokenType = currentWheel === 'normal' ? 'normal' : 'event';
                const remainingSpins = getRemainingSpins(selectedPlayer, tokenType);
                
                if (remainingSpins <= 0) {
                    alert(`No more ${tokenType} spins remaining! You've used all available tokens.`);
                    return;
                }
            }
            
            spinning = true;
            const spinButton = document.getElementById('spinButton');
            spinButton.disabled = true;
            spinButton.textContent = 'Spinning...';
            
            const track = document.getElementById('rouletteTrack');
            
            // Calculate spin distance - simple and reliable
            const trackWidth = track.scrollWidth;
            const containerWidth = track.parentElement.offsetWidth;
            
            // Spin most of the track but not all the way
            const spinDistance = trackWidth * 0.8 + (Math.random() * 200);
            
            track.style.transform = `translateX(-${spinDistance}px)`;
            
            setTimeout(() => {
                // Figure out which item is under the selector
                const itemWidth = 120; // Width of each roulette item
                const margin = 10; // Margin between items
                const selectorPosition = containerWidth / 2;
                
                // Calculate which item index is under the selector
                const totalItemWidth = itemWidth + margin;
                const trackPosition = parseFloat(track.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
                const absolutePosition = Math.abs(trackPosition);
                
                // Find which item is centered under the selector
                let winningIndex = Math.floor((absolutePosition + selectorPosition) / totalItemWidth);
                
                // Make sure index is within bounds
                winningIndex = winningIndex % rouletteItems.length;
                
                // Get the winning item from the roulette
                let winningItemData = rouletteItems[winningIndex];
                
                // Record the spin
                const history = loadSpinsHistory();
                
                if (currentWheel === 'daily') {
                    history[selectedPlayer + '_daily_timestamp'] = new Date().toISOString();
                    // Store daily win
                    const dailyWins = JSON.parse(localStorage.getItem('daily_wins_history') || '{}');
                    if (!dailyWins[selectedPlayer]) dailyWins[selectedPlayer] = [];
                    dailyWins[selectedPlayer].push({
                        item: winningItemData.name,
                        id: winningItemData.id,
                        count: winningItemData.count,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('daily_wins_history', JSON.stringify(dailyWins));
                    
                    // Show result with the actual item that landed
                    showResult(winningItemData, false);
                } else {
                    const tokenType = currentWheel === 'normal' ? 'normal' : 'event';
                    const historyKey = selectedPlayer + (tokenType === 'event' ? '_event' : '');
                    history[historyKey] = (history[historyKey] || 0) + 1;
                    
                    // Store Pokemon win
                    const winsHistory = JSON.parse(localStorage.getItem('wheel_wins_history') || '{}');
                    if (!winsHistory[selectedPlayer]) winsHistory[selectedPlayer] = [];
                    winsHistory[selectedPlayer].push({
                        pokemon: winningItemData.pokemon.name,
                        id: winningItemData.pokemon.id,
                        shiny: winningItemData.isShiny,
                        type: tokenType,
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('wheel_wins_history', JSON.stringify(winsHistory));
                    
                    // Show result with the actual item that landed
                    showResult(winningItemData.pokemon, winningItemData.isShiny);
                }
                
                saveSpinsHistory(history);
                
                spinning = false;
                spinButton.disabled = false;
                spinButton.textContent = 'Spin the Wheel!';
                
                // Reset for next spin
                setTimeout(() => {
                    createRoulette();
                }, 500);
                
                updateTokenDisplay();
            }, 4000);
        }

        function showResult(item, isShiny) {
            const popup = document.getElementById('resultPopup');
            const title = document.getElementById('resultTitle');
            const sprite = document.getElementById('resultSprite');
            const name = document.getElementById('resultName');
            const shinyBadge = document.getElementById('shinyBadge');
            const netherstarBadge = document.getElementById('netherstarBadge');
            
            popup.classList.remove('shiny', 'netherstar');
            shinyBadge.style.display = 'none';
            netherstarBadge.style.display = 'none';
            
            if (currentWheel === 'daily') {
                sprite.src = getMinecraftSprite(item.id);
                name.textContent = `${item.name} (${item.count}x)`;
                
                if (item.type === 'netherstar') {
                    popup.classList.add('netherstar');
                    title.textContent = 'üåü NETHER STAR! üåü';
                    netherstarBadge.style.display = 'block';
                } else {
                    title.textContent = 'Daily Reward! üéÅ';
                }
            } else {
                sprite.src = getSprite(item.id, isShiny);
                name.textContent = item.name;
                
                if (isShiny) {
                    popup.classList.add('shiny');
                    title.textContent = 'üåü SHINY LEGENDARY! üåü';
                    shinyBadge.style.display = 'block';
                } else {
                    title.textContent = 'Congratulations! üéâ';
                }
            }
            
            popup.classList.add('show');
            document.getElementById('overlay').classList.add('show');
        }

        function closePopup() {
            document.getElementById('resultPopup').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        }

        // Initialize
        createRoulette();
        updatePokemonList();
        loadTokenData();
    </script>
</body>
</html>
